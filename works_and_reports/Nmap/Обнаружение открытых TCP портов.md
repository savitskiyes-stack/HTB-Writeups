

### Сканирование хостов и портов


Полный стелс скан tcp портов на цели(очень долго):
nmap sudo nmap 10.129.21.252 -p- --packet-trace -n --disable-arp-ping -Pn


Полный скан всех TCP портов на цели:
sudo nmap -p- -sS -Pn --reason 10.129.21.252


Перечисление имен хоста:
sudo nmap -sV -Pn -R 10.129.21.252


пример в выводе:
Service Info: Host: NIX-NMAP-DEFAULT


Сохранить результат(отчет) сканирования во всех форматах:
sudo nmap -p- -sS -Pn --reason 10.129.21.252 -oA target


Преобразовать xml в html:
xsltproc target.xml -o target.html


Чек для сервиса который не обнаружил nmap напрямую:
NC
nc -nv 10.129.2.28 25



Основная информация которые нужно добыть при сканировании:

1. Открытые порты и предоставляемые ими услуги

2\. сервисные версии

3\. Информация о предоставляемых услугах

4\. Операционная система





Всего для отсканированного порта можно получить 6 различных состояний:





+--------------------+-----------------------------------------------------------------------------------------------------------------------------------------------+

| Состояние          | Описание                                                                                                                                      |

+--------------------+-----------------------------------------------------------------------------------------------------------------------------------------------+

| open               | Это означает, что соединение со сканируемым портом установлено. Эти соединения могут быть TCP-соединениями, UDP-дейтаграммами, а также SCTP-соединениями. |

| closed             | Когда порт отображается как закрытый, протокол TCP указывает, что полученный нами пакет содержит RSTфлаг. Этот метод сканирования также можно использовать для определения того, активен ли наш целевой объект или нет. |

| filtered           | Nmap не может корректно определить, открыт или закрыт сканируемый порт, поскольку либо целевой объект не возвращает ответа по этому порту, либо мы получаем от него код ошибки. |

| unfiltered         | Такое состояние порта возникает только во время сканирования TCP-ACK и означает, что порт доступен, но определить, открыт он или закрыт, невозможно. |

| open|filtered      | Если мы не получим ответа для конкретного порта, Nmapмы установим его в это состояние. Это указывает на то, что порт может быть защищен брандмауэром или пакетным фильтром. |

| closed|filtered    | Это состояние возникает только при сканировании IP-адресов в режиме ожидания и указывает на невозможность определить, закрыт ли сканируемый порт или отфильтрован межсетевым экраном. |

+--------------------+-----------------------------------------------------------------------------------------------------------------------------------------------+









### Обнаружение открытых TCP-портов











определять порты по одному:



-p 22,25,80,139,445



по диапазону:



-p 22-445



по наиболее часто используемым портам:



--top-ports=10



все порты:

-p-

100 наиболее часто используемых портов



-F

Пример:
sudo nmap 10.129.2.28 --top-ports=10 


PORT     STATE    SERVICE

21/tcp   closed   ftp

22/tcp   open     ssh

23/tcp   closed   telnet

25/tcp   open     smtp

80/tcp   open     http

110/tcp  open     pop3

139/tcp  filtered netbios-ssn

443/tcp  closed   https

445/tcp  filtered microsoft-ds

3389/tcp closed   ms-wbt-server


Nmap - Отслеживание пакетов

sudo nmap 10.129.2.28 -p 21 --packet-trace -Pn -n --disable-arp-ping

SENT (0.0429s) TCP 10.10.14.2:63090 > 10.129.2.28:21 S ttl=56 id=57322 iplen=44  seq=1699105818 win=1024 <mss 1460>

RCVD (0.0573s) TCP 10.129.2.28:21 > 10.10.14.2:63090 RA ttl=64 id=0 iplen=40  seq=0 win=0



ЗАПРОС:

+--------------------+-----------------------------------------------------------------------------------------------------------------------------------------------+

| Сообщение          | Описание                                                                                                                                      |

+--------------------+-----------------------------------------------------------------------------------------------------------------------------------------------+

| SENT (0.0429s)     | Указывает на операцию SENT программы Nmap, которая отправляет пакет целевому объекту.                                                        |

| TCP                | Отображает протокол, используемый для взаимодействия с целевым портом.                                                                        |

| 10.10.14.2:63090 > | Здесь указывается наш IPv4-адрес и исходный порт, которые будут использоваться Nmap для отправки пакетов.                                     |

| 10.129.2.28:21     | Отображает целевой IPv4-адрес и целевой порт.                                                                                                 |

| S                  | Флаг SYN отправленного TCP-пакета.                                                                                                            |

| ttl=56 id=57322 iplen=44 seq=1699105818 win=1024 mss 1460 | Дополнительные параметры пакета: TTL, ID, длина, sequence number, window size и MSS.                                                         |

+--------------------+-----------------------------------------------------------------------------------------------------------------------------------------------+

ОТВЕТ

+-----------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------+

| Сообщение                               | Описание                                                                                                                                      |

+-----------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------+

| RCVD (0.0573s)                          | Указывает на получение пакета от целевого устройства.                                                                                         |

| TCP                                     | Отображает используемый протокол.                                                                                                             |

| 10.129.2.28:21 >                        | Представляет собой IPv4-адрес цели и исходный порт, которые будут использоваться для ответа.                                                  |

| 10.10.14.2:63090                        | Отображает наш IPv4-адрес и порт, на который будет отправлен ответ.                                                                           |

| RA                                      | Флаги RST и ACK отправленного TCP-пакета.                                                                                                     |

| ttl=64 id=0 iplen=40 seq=0 win=0        | Дополнительные параметры заголовка TCP.                                                                                                       |

+-----------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------+





ВАЖНО:

сканирование TCP-соединения — один из наименее скрытных методов, поскольку оно полностью устанавливает соединение, что приводит к созданию журналов в большинстве систем и легко обнаруживается современными решениями IDS/IPS




Полезность в реальном пентесте:
Быстрое подтверждение, что порт 21 закрыт
Если в других пакетах TTL тоже 64 — уверенно работаем под Linux (ищем SSH, Apache/Nginx, Docker, cron, sudo-права и т.д.)
IP ID=0 помогает отличить Linux от других Unix-подобных систем
Получаем предварительный отпечаток ОС без запуска ресурсоёмкого -O

тф
-n                            Отключает разрешение DNS-запросов.
--disable-arp-ping            Отключает ARP-пинг.


В большинстве случаев межсетевые экраны имеют определенные правила для обработки конкретных соединений
Пакеты могут быть либо отфильтрованными dropped, либо нет rejected
Когда пакет отбрасывается, Nmapсистема не получает ответа от целевого порта, и по умолчанию частота повторных попыток ( --max-retries) устанавливается на 10
брандмауэр блокирует dropsTCP-пакеты, отправляемые для сканирования портов. Поэтому сканируем TCP-порт 139 , который уже был отмечен как отфильтрованный. Чтобы отслеживать обработку отправленных пакетов, мы снова отключаем запросы эхо-ответа ICMP ( -Pn), разрешение DNS ( -n) и сканирование ARP-пинга ( --disable-arp-ping)

sudo nmap 10.129.2.28 -p 139 --packet-trace -n --disable-arp-ping -Pn


SENT (0.0381s) TCP 10.10.14.2:60277 > 10.129.2.28:139 S ttl=47 id=14523 iplen=44  seq=4175236769 win=1024 <mss 1460>

SENT (1.0411s) TCP 10.10.14.2:60278 > 10.129.2.28:139 S ttl=45 id=7372 iplen=44  seq=4175171232 win=1024 <mss 1460>



видим, что Nmapбыли отправлены два TCP-пакета с флагом SYN. ​​По длительности ( 2.06s) сканирования можно заметить, что оно заняло гораздо больше времени, чем предыдущие ( ~0.05s). Ситуация меняется, если межсетевой экран отклоняет пакеты
Ситуация меняется, если межсетевой экран отклоняет пакеты

TCP-порт 445, который обрабатывается соответствующим правилом межсетевого экран

sudo nmap 10.129.2.28 -p 445 --packet-trace -n --disable-arp-ping -Pn

SENT (0.0388s) TCP 10.129.2.28:52472 > 10.129.2.28:445 S ttl=49 id=21763 iplen=44  seq=1418633433 win=1024 <mss 1460>

RCVD (0.0487s) ICMP \[10.129.2.28 > 10.129.2.28 Port 445 unreachable (type=3/code=3) ] IP \[ttl=64 id=20998 iplen=72 ]

 получаем ICMPсообщение с символами type 3и error code 3, что указывает на недоступность запрашиваемого порта
если знаем, что хост активен, можем с уверенностью предположить, что брандмауэр на этом порту отклоняет пакеты, и придётся более внимательно изучить этот порт позже





Результаты можно сохранить в 3 различных форматах:

Обычный вывод ( -oN) с .nmapрасширением файла
Вывод, допускающий поиск по расширению файла ( -oG).gnmap
Вывод в формате XML ( -oX) с .xmlрасширением файла

-oA для сохранение во всех форматах
sudo nmap 10.129.2.28 -p- -oA target

-oA target Сохраняет результаты во всех форматах, начиная имя каждого файла с "target"


Обычный вывод:
cat target.nmap


Вывод, допускающий использование grep:
cat target.gnmap


Вывод в формате XML
cat target.xml
Благодаря XML-выводу мы можем легко создавать HTML-отчеты, которые легко читаются даже нетехническими специалистами


Можно открыть в браузере и увидить четкое структурированное представление результатов
xsltproc target.xml -o target.html



verbosity level( -v/ -vv), что позволит напрямую видеть открытые порты при Nmapих обнаружении:
sudo nmap 10.129.2.28 -p- -sV -v



sudo tcpdump -i eth0 host 10.10.14.2 and 10.129.2.28



Если мы подключимся к SMTP-серверу с помощью команды `sudo` nc, получим баннер и перехватим 
сетевой трафик с помощью команды `sudo` tcpdump, можно увидеть то, что Nmapом не было показано




Tcpdump
sudo tcpdump -i eth0 host 10.10.14.2 and 10.129.2.28

tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes


Чек для сервиса который не обнаружил nmap напрямую:
NC
nc -nv 10.129.2.28 25

Connection to 10.129.2.28 port 25 [tcp/*] succeeded!
220 inlane ESMTP Postfix (Ubuntu)





Tcpdump - Перехваченный трафик:
18:28:07.128564 IP 10.10.14.2.59618 > 10.129.2.28.smtp: Flags [S], seq 1798872233, win 65535, options [mss 1460,nop,wscale 6,nop,nop,TS val 331260178 ecr 0,sackOK,eol], length 0
18:28:07.255151 IP 10.129.2.28.smtp > 10.10.14.2.59618: Flags [S.], seq 1130574379, ack 1798872234, win 65160, options [mss 1460,sackOK,TS val 1800383922 ecr 331260178,nop,wscale 7], length 0
18:28:07.255281 IP 10.10.14.2.59618 > 10.129.2.28.smtp: Flags [.], ack 1, win 2058, options [nop,nop,TS val 331260304 ecr 1800383922], length 0
18:28:07.319306 IP 10.129.2.28.smtp > 10.10.14.2.59618: Flags [P.], seq 1:36, ack 1, win 510, options [nop,nop,TS val 1800383985 ecr 331260304], length 35: SMTP: 220 inlane ESMTP Postfix (Ubuntu)
18:28:07.319426 IP 10.10.14.2.59618 > 10.129.2.28.smtp: Flags [.], ack 36, win 2058, options [nop,nop,TS val 331260368 ecr 1800383985], length 0

















